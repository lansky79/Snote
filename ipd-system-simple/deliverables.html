<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº¤ä»˜ç‰©ç®¡ç† - æºè¸”ç§‘æŠ€é›†æˆäº§å“å¼€å‘ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/common.css" />
  </head>
  <body>
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="system-title">
          <div class="company-name">æºè¸”ç§‘æŠ€</div>
          <div class="system-name">é›†æˆäº§å“å¼€å‘ç®¡ç†ç³»ç»Ÿ</div>
        </div>
      </div>
      <div class="nav-menu">
        <a href="index.html">é¡¹ç›®æ¦‚è§ˆ</a>
        <a href="dashboard.html">æ•°æ®åˆ†æ</a>
        <a href="team.html">å›¢é˜Ÿåä½œ</a>
        <a href="stages.html">é˜¶æ®µç®¡ç†</a>
        <a href="dcp.html">DCPè¯„å®¡</a>
        <a href="deliverables.html">äº¤ä»˜ç‰©ç®¡ç†</a>
        <a href="reports.html">æŠ¥è¡¨ä¸­å¿ƒ</a>
        <a href="users-simple.html">ç”¨æˆ·ç®¡ç†</a>
        <a href="help.html">å¸®åŠ©ä¸­å¿ƒ</a>
        <a href="settings.html">ç³»ç»Ÿè®¾ç½®</a>
        <a href="#" onclick="logout()" class="logout">é€€å‡º</a>
      </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
      <!-- äº¤ä»˜ç‰©ç»Ÿè®¡ -->
      <div class="grid grid-4" style="margin-bottom: 30px">
        <div class="stat-card">
          <div class="stat-number" id="total-deliverables">0</div>
          <div class="stat-label">æ€»äº¤ä»˜ç‰©</div>
        </div>
        <div class="stat-card">
          <div
            class="stat-number"
            id="approved-deliverables"
            style="color: #27ae60"
          >
            0
          </div>
          <div class="stat-label">å·²æ‰¹å‡†</div>
        </div>
        <div class="stat-card">
          <div
            class="stat-number"
            id="pending-deliverables"
            style="color: #e74c3c"
          >
            0
          </div>
          <div class="stat-label">å¾…å®¡æ ¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-downloads" style="color: #3498db">
            0
          </div>
          <div class="stat-label">æ€»ä¸‹è½½é‡</div>
        </div>
      </div>

      <!-- äº¤ä»˜ç‰©åˆ—è¡¨ -->
      <div class="card">
        <div
          style="display: flex; justify-content: flex-end; margin-bottom: 15px"
        >
          <button
            class="btn btn-primary"
            onclick="showAlert('ä¸Šä¼ äº¤ä»˜ç‰©åŠŸèƒ½å¼€å‘ä¸­')"
          >
            ä¸Šä¼ äº¤ä»˜ç‰©
          </button>
        </div>
        <div class="card-content">
          <div id="deliverables-container" class="grid grid-3">
            <!-- äº¤ä»˜ç‰©å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </main>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
      // æ¸²æŸ“äº¤ä»˜ç‰©ç»Ÿè®¡
      function renderDeliverablesStats() {
        var deliverables = IPD_DATA.deliverables;
        var totalDeliverables = deliverables.length;
        var approvedDeliverables = deliverables.filter(function (d) {
          return d.approvalStatus === "approved";
        }).length;
        var pendingDeliverables = deliverables.filter(function (d) {
          return (
            d.approvalStatus === "pending" ||
            d.approvalStatus === "under_review"
          );
        }).length;
        var totalDownloads = deliverables.reduce(function (sum, d) {
          return sum + (d.downloadCount || 0);
        }, 0);

        document.getElementById("total-deliverables").textContent =
          totalDeliverables;
        document.getElementById("approved-deliverables").textContent =
          approvedDeliverables;
        document.getElementById("pending-deliverables").textContent =
          pendingDeliverables;
        document.getElementById("total-downloads").textContent = totalDownloads;
      }

      // è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡
      function getFileTypeIcon(type) {
        var icons = {
          document: "ğŸ“„",
          prototype: "ğŸ¨",
          code: "ğŸ’»",
          design: "ğŸ¯",
          image: "ğŸ–¼ï¸",
          video: "ğŸ¥",
        };
        return icons[type] || "ğŸ“";
      }

      // è·å–å®¡æ‰¹çŠ¶æ€æ ·å¼
      function getApprovalStatusClass(status) {
        var statusMap = {
          approved: "status-completed",
          pending: "status-not-started",
          under_review: "status-in-progress",
          rejected: "status-blocked",
        };
        return statusMap[status] || "status-not-started";
      }

      // è·å–å®¡æ‰¹çŠ¶æ€æ–‡æœ¬
      function getApprovalStatusText(status) {
        var statusMap = {
          approved: "å·²æ‰¹å‡†",
          pending: "å¾…å®¡æ ¸",
          under_review: "å®¡æ ¸ä¸­",
          rejected: "å·²æ‹’ç»",
        };
        return statusMap[status] || "æœªçŸ¥çŠ¶æ€";
      }

      // æ¸²æŸ“äº¤ä»˜ç‰©åˆ—è¡¨
      function renderDeliverables() {
        var container = document.getElementById("deliverables-container");
        var deliverables = IPD_DATA.deliverables;
        var html = "";

        if (deliverables.length === 0) {
          html = '<div class="empty-state" style="grid-column: 1 / -1;">';
          html += '<div class="empty-state-icon">ğŸ“</div>';
          html += '<div class="empty-state-text">æš‚æ— äº¤ä»˜ç‰©</div>';
          html += "</div>";
        } else {
          for (var i = 0; i < deliverables.length; i++) {
            var deliverable = deliverables[i];
            var project = getProjectById(deliverable.projectId);
            var uploader = getUserById(deliverable.uploadedBy);
            var approver = deliverable.approvedBy
              ? getUserById(deliverable.approvedBy)
              : null;

            html += '<div class="card" style="margin: 0;">';
            html +=
              '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">';
            html +=
              '<div style="display: flex; align-items: center; gap: 10px; flex: 1;">';
            html +=
              '<span style="font-size: 1.5em;">' +
              getFileTypeIcon(deliverable.type) +
              "</span>";
            html += "<div>";
            html +=
              '<h4 style="margin: 0; color: #2c3e50; font-size: 1em;">' +
              deliverable.name +
              "</h4>";
            html +=
              '<div style="color: #666; font-size: 0.8em; margin-top: 2px;">v' +
              deliverable.version +
              "</div>";
            html += "</div>";
            html += "</div>";
            html +=
              '<span class="status-badge ' +
              getApprovalStatusClass(deliverable.approvalStatus) +
              '">' +
              getApprovalStatusText(deliverable.approvalStatus) +
              "</span>";
            html += "</div>";

            html +=
              '<p style="color: #666; margin-bottom: 15px; font-size: 0.9em; line-height: 1.4;">' +
              deliverable.description +
              "</p>";

            html +=
              '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 0.85em;">';
            html += "<div>";
            html += '<span style="color: #666;">é¡¹ç›®:</span>';
            html +=
              '<div style="font-weight: bold; color: #2c3e50; margin-top: 2px; font-size: 0.9em;">' +
              (project ? project.name : "æœªçŸ¥é¡¹ç›®") +
              "</div>";
            html += "</div>";
            html += "<div>";
            html += '<span style="color: #666;">é˜¶æ®µ:</span>';
            html +=
              '<div style="font-weight: bold; color: #2c3e50; margin-top: 2px;">' +
              getStageText(deliverable.stage) +
              "</div>";
            html += "</div>";
            html += "<div>";
            html += '<span style="color: #666;">ä¸Šä¼ è€…:</span>';
            html +=
              '<div style="font-weight: bold; color: #2c3e50; margin-top: 2px;">' +
              (uploader ? uploader.name : "æœªçŸ¥ç”¨æˆ·") +
              "</div>";
            html += "</div>";
            html += "<div>";
            html += '<span style="color: #666;">æ–‡ä»¶å¤§å°:</span>';
            html +=
              '<div style="font-weight: bold; color: #2c3e50; margin-top: 2px;">' +
              deliverable.fileSize +
              "</div>";
            html += "</div>";
            html += "</div>";

            html +=
              '<div style="color: #999; font-size: 0.8em; margin-bottom: 15px;">';
            html += "ä¸Šä¼ æ—¶é—´: " + formatDate(deliverable.uploadedAt);
            if (deliverable.downloadCount) {
              html += " â€¢ ä¸‹è½½: " + deliverable.downloadCount + " æ¬¡";
            }
            html += "</div>";

            html += '<div style="display: flex; gap: 8px;">';
            html +=
              '<button class="btn btn-outline" onclick="viewDeliverableDetail(\'' +
              deliverable.id +
              '\')" style="flex: 1; padding: 6px 10px; font-size: 0.8em;">æŸ¥çœ‹è¯¦æƒ…</button>';
            html +=
              '<button class="btn btn-primary" onclick="showAlert(\'ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­\')" style="flex: 1; padding: 6px 10px; font-size: 0.8em;">ä¸‹è½½</button>';
            if (deliverable.approvalStatus === "pending") {
              html +=
                '<button class="btn btn-success" onclick="showAlert(\'å®¡æ ¸åŠŸèƒ½å¼€å‘ä¸­\')" style="flex: 1; padding: 6px 10px; font-size: 0.8em;">å®¡æ ¸</button>';
            }
            html += "</div>";
            html += "</div>";
          }
        }

        container.innerHTML = html;
      }

      // æŸ¥çœ‹äº¤ä»˜ç‰©è¯¦æƒ…
      function viewDeliverableDetail(deliverableId) {
        var deliverable = IPD_DATA.deliverables.find(function (d) {
          return d.id === deliverableId;
        });
        if (!deliverable) {
          showErrorMessage("äº¤ä»˜ç‰©ä¸å­˜åœ¨");
          return;
        }

        var project = getProjectById(deliverable.projectId);
        var uploader = getUserById(deliverable.uploadedBy);
        var approver = deliverable.approvedBy
          ? getUserById(deliverable.approvedBy)
          : null;
        var content = "<div>";

        content +=
          '<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">';
        content +=
          '<span style="font-size: 3em;">' +
          getFileTypeIcon(deliverable.type) +
          "</span>";
        content += '<div style="flex: 1;">';
        content +=
          '<h4 style="color: #2c3e50; margin-bottom: 8px;">' +
          deliverable.name +
          "</h4>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">ç‰ˆæœ¬: v' +
          deliverable.version +
          "</div>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">æ–‡ä»¶å: ' +
          deliverable.fileName +
          "</div>";
        content +=
          '<div style="color: #666;">æ–‡ä»¶å¤§å°: ' +
          deliverable.fileSize +
          "</div>";
        content += "</div>";
        content += '<div style="text-align: right;">';
        content +=
          '<span class="status-badge ' +
          getApprovalStatusClass(deliverable.approvalStatus) +
          '">' +
          getApprovalStatusText(deliverable.approvalStatus) +
          "</span>";
        content += "</div>";
        content += "</div>";

        content += '<div style="margin-bottom: 25px;">';
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">åŸºæœ¬ä¿¡æ¯</h5>';
        content +=
          '<div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">';
        content +=
          '<p style="color: #2c3e50; line-height: 1.6; margin-bottom: 15px;">' +
          deliverable.description +
          "</p>";
        content +=
          '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';
        content += "<div>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">å…³è”é¡¹ç›®</div>';
        content +=
          '<div style="font-weight: bold; color: #2c3e50;">' +
          (project ? project.name : "æœªçŸ¥é¡¹ç›®") +
          "</div>";
        content += "</div>";
        content += "<div>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">æ‰€å±é˜¶æ®µ</div>';
        content +=
          '<div style="font-weight: bold; color: #2c3e50;">' +
          getStageText(deliverable.stage) +
          "</div>";
        content += "</div>";
        content += "<div>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">æ–‡æ¡£ç±»åˆ«</div>';
        content +=
          '<div style="font-weight: bold; color: #2c3e50;">' +
          deliverable.category +
          "</div>";
        content += "</div>";
        content += "<div>";
        content += '<div style="color: #666; margin-bottom: 5px;">ä¼˜å…ˆçº§</div>';
        content +=
          '<div style="font-weight: bold; color: #2c3e50;">' +
          (deliverable.priority === "high"
            ? "é«˜"
            : deliverable.priority === "medium"
            ? "ä¸­"
            : "ä½") +
          "</div>";
        content += "</div>";
        content += "</div>";
        content += "</div>";
        content += "</div>";

        content += '<div style="margin-bottom: 25px;">';
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">ä¸Šä¼ ä¿¡æ¯</h5>';
        content +=
          '<div style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        if (uploader) {
          content += createAvatar(uploader.name);
          content += '<div style="margin-left: 12px; flex: 1;">';
          content +=
            '<div style="font-weight: bold; color: #2c3e50;">' +
            uploader.name +
            "</div>";
          content +=
            '<div style="color: #666; font-size: 0.9em;">' +
            uploader.department +
            " - " +
            uploader.role +
            "</div>";
          content += "</div>";
        } else {
          content += '<div style="color: #666;">ä¸Šä¼ è€…ä¿¡æ¯ä¸å¯ç”¨</div>';
        }
        content +=
          '<div style="text-align: right; color: #666; font-size: 0.9em;">';
        content += formatDate(deliverable.uploadedAt);
        content += "</div>";
        content += "</div>";
        content += "</div>";

        if (deliverable.approvalStatus === "approved" && approver) {
          content += '<div style="margin-bottom: 25px;">';
          content +=
            '<h5 style="color: #2c3e50; margin-bottom: 15px;">å®¡æ‰¹ä¿¡æ¯</h5>';
          content +=
            '<div style="display: flex; align-items: center; padding: 15px; background: #d5f4e6; border-radius: 6px;">';
          content += createAvatar(approver.name);
          content += '<div style="margin-left: 12px; flex: 1;">';
          content +=
            '<div style="font-weight: bold; color: #2c3e50;">' +
            approver.name +
            "</div>";
          content +=
            '<div style="color: #666; font-size: 0.9em;">å®¡æ‰¹é€šè¿‡</div>';
          content += "</div>";
          content +=
            '<div style="text-align: right; color: #666; font-size: 0.9em;">';
          content += formatDate(deliverable.approvedAt);
          content += "</div>";
          content += "</div>";
          content += "</div>";
        }

        content += "<div>";
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">ä½¿ç”¨ç»Ÿè®¡</h5>';
        content +=
          '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">';
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: #3498db; margin-bottom: 5px;">' +
          (deliverable.downloadCount || 0) +
          "</div>";
        content += '<div style="color: #666; font-size: 0.9em;">ä¸‹è½½æ¬¡æ•°</div>';
        content += "</div>";
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: #f39c12; margin-bottom: 5px;">' +
          deliverable.version +
          "</div>";
        content += '<div style="color: #666; font-size: 0.9em;">å½“å‰ç‰ˆæœ¬</div>';
        content += "</div>";
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: #9b59b6; margin-bottom: 5px;">' +
          deliverable.fileSize +
          "</div>";
        content += '<div style="color: #666; font-size: 0.9em;">æ–‡ä»¶å¤§å°</div>';
        content += "</div>";
        content += "</div>";
        content += "</div>";

        content += "</div>";

        showModal("äº¤ä»˜ç‰©è¯¦æƒ…", content);
      }

      // é¡µé¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
          window.location.href = "login.html";
          return;
        }

        loadData(function () {
          safeRender(renderDeliverablesStats, "total-deliverables");
          safeRender(renderDeliverables, "deliverables-container");
        });
      });
    </script>
  </body>
</html>
