<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>用户管理 - 源踔科技集成产品开发管理系统</title>
    <link rel="stylesheet" href="css/common.css" />
  </head>
  <body>
    <!-- 左侧导航栏 -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="system-title">
          <div class="company-name">源踔科技</div>
          <div class="system-name">集成产品开发管理系统</div>
        </div>
      </div>
      <div class="nav-menu">
        <a href="index.html">项目概览</a>
        <a href="dashboard.html">数据分析</a>
        <a href="team.html">团队协作</a>
        <a href="stages.html">阶段管理</a>
        <a href="dcp.html">DCP评审</a>
        <a href="deliverables.html">交付物管理</a>
        <a href="reports.html">报表中心</a>
        <a href="users.html">用户管理</a>
        <a href="help.html">帮助</a>
        <a href="settings.html">系统设置</a>
        <a href="#" onclick="logout()" class="logout">退出</a>
      </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="main-content">
      <!-- 用户统计 -->
      <div class="grid grid-4" style="margin-bottom: 30px">
        <div class="stat-card">
          <div class="stat-number" id="total-users">0</div>
          <div class="stat-label">总用户数</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-users" style="color: #27ae60">
            0
          </div>
          <div class="stat-label">活跃用户</div>
        </div>
        <div class="stat-card">
          <div
            class="stat-number"
            id="departments-count"
            style="color: #3498db"
          >
            0
          </div>
          <div class="stat-label">部门数量</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avg-tasks" style="color: #f39c12">0</div>
          <div class="stat-label">平均任务数</div>
        </div>
      </div>

      <!-- 用户列表 -->
      <div class="card">
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px;">
            <button
              class="btn btn-secondary"
              onclick="showAlert('导出功能开发中')"
            >
              导出用户
            </button>
            <button
              class="btn btn-primary"
              onclick="showAlert('添加用户功能开发中')"
            >
              添加用户
            </button>
          </div>
        </div>
        <div class="card-content">
          <div style="overflow-x: auto">
            <table class="table">
              <thead>
                <tr>
                  <th>用户信息</th>
                  <th>部门职位</th>
                  <th>联系方式</th>
                  <th>工作负载</th>
                  <th>任务统计</th>
                  <th>参与项目</th>
                  <th>最后登录</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <!-- 用户数据将通过JavaScript动态生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- 引入脚本 -->
    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
      // 渲染用户统计
      function renderUserStats() {
        var users = IPD_DATA.users;
        var totalUsers = users.length;
        var activeUsers = users.filter(function (u) {
          return u.status === "active";
        }).length;

        // 计算部门数量
        var departments = {};
        for (var i = 0; i < users.length; i++) {
          departments[users[i].department] = true;
        }
        var departmentsCount = Object.keys(departments).length;

        // 计算平均任务数
        var avgTasks =
          totalUsers > 0
            ? Math.round(
                users.reduce(function (sum, u) {
                  return sum + u.completedTasks + u.ongoingTasks;
                }, 0) / totalUsers
              )
            : 0;

        document.getElementById("total-users").textContent = totalUsers;
        document.getElementById("active-users").textContent = activeUsers;
        document.getElementById("departments-count").textContent =
          departmentsCount;
        document.getElementById("avg-tasks").textContent = avgTasks;
      }

      // 获取用户级别颜色
      function getLevelColor(level) {
        var colors = {
          高级: "#e74c3c",
          中级: "#f39c12",
          初级: "#3498db",
        };
        return colors[level] || "#95a5a6";
      }

      // 渲染用户表格
      function renderUsersTable() {
        var tbody = document.getElementById("users-table-body");
        var users = IPD_DATA.users;
        var html = "";

        for (var i = 0; i < users.length; i++) {
          var user = users[i];
          var workloadColor = user.workload > 80 ? "#e74c3c" : "#27ae60";
          var totalTasks = user.completedTasks + user.ongoingTasks;

          html += "<tr>";

          // 用户信息
          html += "<td>";
          html +=
            '<div style="display: flex; align-items: center; gap: 12px;">';
          html += createAvatar(user.name);
          html += "<div>";
          html +=
            '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px;">' +
            user.name +
            "</div>";
          html +=
            '<div style="color: #666; font-size: 0.8em;">ID: ' +
            user.id +
            "</div>";
          html += "</div>";
          html += "</div>";
          html += "</td>";

          // 部门职位
          html += "<td>";
          html += '<div style="margin-bottom: 4px;">';
          html +=
            '<div style="font-weight: bold; color: #2c3e50;">' +
            user.department +
            "</div>";
          html +=
            '<div style="color: #666; font-size: 0.9em;">' +
            user.role +
            "</div>";
          html += "</div>";
          html +=
            '<span style="background: ' +
            getLevelColor(user.level) +
            '; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">' +
            user.level +
            "</span>";
          html += "</td>";

          // 联系方式
          html += "<td>";
          html += '<div style="font-size: 0.9em;">';
          html +=
            '<div style="margin-bottom: 2px; color: #2c3e50;">' +
            user.email +
            "</div>";
          html += '<div style="color: #666;">' + user.phone + "</div>";
          html += "</div>";
          html += "</td>";

          // 工作负载
          html += "<td>";
          html +=
            '<div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">';
          html +=
            '<span style="font-weight: bold; color: ' +
            workloadColor +
            ';">' +
            user.workload +
            "%</span>";
          html +=
            '<div style="width: 60px; background: #ecf0f1; height: 6px; border-radius: 3px; overflow: hidden;">';
          html +=
            '<div style="background: ' +
            workloadColor +
            "; height: 100%; width: " +
            user.workload +
            '%;"></div>';
          html += "</div>";
          html += "</div>";
          html += "</td>";

          // 任务统计
          html += "<td>";
          html += '<div style="text-align: center;">';
          html +=
            '<div style="color: #27ae60; font-size: 0.9em; margin-bottom: 2px;">完成: ' +
            user.completedTasks +
            "</div>";
          html +=
            '<div style="color: #f39c12; font-size: 0.9em;">进行: ' +
            user.ongoingTasks +
            "</div>";
          html += "</div>";
          html += "</td>";

          // 参与项目
          html += "<td>";
          html += '<div style="text-align: center;">';
          html +=
            '<span style="font-weight: bold; color: #3498db; font-size: 1.1em;">' +
            user.projects.length +
            "</span>";
          html += '<div style="color: #666; font-size: 0.8em;">个项目</div>';
          html += "</div>";
          html += "</td>";

          // 最后登录
          html += "<td>";
          html +=
            '<div style="font-size: 0.8em; color: #666;">' +
            formatDateTime(user.lastLogin) +
            "</div>";
          html += "</td>";

          // 操作
          html += "<td>";
          html += '<div style="display: flex; gap: 5px;">';
          html +=
            '<button class="btn btn-outline" onclick="viewUserDetail(\'' +
            user.id +
            '\')" style="padding: 4px 8px; font-size: 0.8em;">详情</button>';
          html +=
            '<button class="btn btn-primary" onclick="showAlert(\'编辑功能开发中\')" style="padding: 4px 8px; font-size: 0.8em;">编辑</button>';
          html += "</div>";
          html += "</td>";

          html += "</tr>";
        }

        tbody.innerHTML = html;
      }

      // 格式化日期时间
      function formatDateTime(dateTimeString) {
        if (!dateTimeString) return "从未登录";
        try {
          var date = new Date(dateTimeString);
          return (
            date.toLocaleDateString("zh-CN") +
            " " +
            date.toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        } catch (error) {
          return "日期格式错误";
        }
      }

      // 查看用户详情
      function viewUserDetail(userId) {
        var user = getUserById(userId);
        if (!user) {
          showErrorMessage("用户不存在");
          return;
        }

        var content = "<div>";

        // 用户基本信息
        content +=
          '<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">';
        content +=
          '<div style="width: 80px; height: 80px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 2em;">';
        content += user.name.charAt(0);
        content += "</div>";
        content += '<div style="flex: 1;">';
        content +=
          '<h3 style="color: #2c3e50; margin-bottom: 8px;">' +
          user.name +
          "</h3>";
        content +=
          '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em;">';
        content += "<div><strong>邮箱:</strong> " + user.email + "</div>";
        content += "<div><strong>电话:</strong> " + user.phone + "</div>";
        content += "<div><strong>部门:</strong> " + user.department + "</div>";
        content += "<div><strong>职位:</strong> " + user.role + "</div>";
        content +=
          '<div><strong>级别:</strong> <span style="background: ' +
          getLevelColor(user.level) +
          '; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">' +
          user.level +
          "</span></div>";
        content +=
          "<div><strong>入职时间:</strong> " +
          formatDate(user.joinDate) +
          "</div>";
        content += "</div>";
        content += "</div>";
        content += "</div>";

        // 工作统计
        content += '<div style="margin-bottom: 25px;">';
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">工作统计</h5>';
        content +=
          '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: ' +
          (user.workload > 80 ? "#e74c3c" : "#27ae60") +
          '; margin-bottom: 5px;">' +
          user.workload +
          "%</div>";
        content += '<div style="color: #666; font-size: 0.9em;">工作负载</div>';
        content += "</div>";
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: #3498db; margin-bottom: 5px;">' +
          user.completedTasks +
          "</div>";
        content +=
          '<div style="color: #666; font-size: 0.9em;">已完成任务</div>';
        content += "</div>";
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: #f39c12; margin-bottom: 5px;">' +
          user.ongoingTasks +
          "</div>";
        content +=
          '<div style="color: #666; font-size: 0.9em;">进行中任务</div>';
        content += "</div>";
        content +=
          '<div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">';
        content +=
          '<div style="font-size: 1.5em; font-weight: bold; color: #9b59b6; margin-bottom: 5px;">' +
          user.projects.length +
          "</div>";
        content += '<div style="color: #666; font-size: 0.9em;">参与项目</div>';
        content += "</div>";
        content += "</div>";
        content += "</div>";

        // 参与项目
        content += '<div style="margin-bottom: 25px;">';
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">参与项目</h5>';
        if (user.projects.length > 0) {
          for (var i = 0; i < user.projects.length; i++) {
            var project = getProjectById(user.projects[i]);
            if (project) {
              content +=
                '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 4px; margin-bottom: 8px;">';
              content += '<div style="flex: 1;">';
              content +=
                '<div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px;">' +
                project.name +
                "</div>";
              content +=
                '<div style="color: #666; font-size: 0.8em;">' +
                getStageText(project.currentStage) +
                " • 预算: ¥" +
                (project.budget / 10000).toFixed(1) +
                "万</div>";
              content += "</div>";
              content += '<div style="text-align: right;">';
              content += createStatusBadge(project.status);
              content +=
                '<div style="margin-top: 4px; font-size: 0.8em; color: #3498db; font-weight: bold;">' +
                project.progress +
                "%</div>";
              content += "</div>";
              content += "</div>";
            }
          }
        } else {
          content +=
            '<div style="color: #999; font-style: italic; text-align: center; padding: 20px;">暂未参与任何项目</div>';
        }
        content += "</div>";

        // 技能专长
        content += '<div style="margin-bottom: 25px;">';
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">技能专长</h5>';
        content += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
        for (var j = 0; j < user.skills.length; j++) {
          content +=
            '<span style="background: #3498db; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9em;">' +
            user.skills[j] +
            "</span>";
        }
        content += "</div>";
        content += "</div>";

        // 登录信息
        content += "<div>";
        content +=
          '<h5 style="color: #2c3e50; margin-bottom: 15px;">登录信息</h5>';
        content +=
          '<div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">';
        content +=
          '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';
        content += "<div>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">账户状态</div>';
        content +=
          '<div style="font-weight: bold; color: ' +
          (user.status === "active" ? "#27ae60" : "#e74c3c") +
          ';">' +
          (user.status === "active" ? "活跃" : "非活跃") +
          "</div>";
        content += "</div>";
        content += "<div>";
        content +=
          '<div style="color: #666; margin-bottom: 5px;">最后登录</div>';
        content +=
          '<div style="font-weight: bold; color: #2c3e50;">' +
          formatDateTime(user.lastLogin) +
          "</div>";
        content += "</div>";
        content += "</div>";
        content += "</div>";
        content += "</div>";

        content += "</div>";

        showModal("用户详情", content);
      }

      // 页面初始化
      document.addEventListener("DOMContentLoaded", function () {
        // 检查登录状态
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
          window.location.href = "login.html";
          return;
        }

        loadData(function () {
          safeRender(renderUserStats, "total-users");
          safeRender(renderUsersTable, "users-table-body");
        });
      });
    </script>
  </body>
</html>
