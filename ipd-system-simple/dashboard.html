<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>仪表板 - 源踔科技集成产品开发管理系统</title>
    <link rel="stylesheet" href="css/common.css" />
  </head>
  <body>
    <!-- 左侧导航栏 -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="system-title">
          <div class="company-name">源踔科技</div>
          <div class="system-name">集成产品开发管理系统</div>
        </div>
      </div>
      <div class="nav-menu">
        <a href="index.html">项目概览</a>
        <a href="dashboard.html">数据分析</a>
        <a href="team.html">团队协作</a>
        <a href="stages.html">阶段管理</a>
        <a href="dcp.html">DCP评审</a>
        <a href="deliverables.html">交付物管理</a>
        <a href="reports.html">报表中心</a>
        <a href="users.html">用户管理</a>
        <a href="help.html">帮助中心</a>
        <a href="settings.html">系统设置</a>
        <a href="#" onclick="logout()" class="logout">退出</a>
      </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="main-content">
      <!-- 综合数据分析面板 -->
      <div class="card" style="height: calc(100vh - 80px); overflow: hidden">
        <div
          style="
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
          "
        >
          <button
            class="btn btn-outline"
            onclick="refreshData()"
            style="padding: 6px 12px; font-size: 0.9em"
          >
            刷新数据
          </button>
          <select
            id="timeRange"
            onchange="filterByTime()"
            style="
              padding: 6px;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 0.9em;
            "
          >
            <option value="all">全部时间</option>
            <option value="month">近一月</option>
            <option value="quarter">近一季度</option>
            <option value="year">近一年</option>
          </select>
        </div>
        <div
          class="card-content"
          style="height: calc(100% - 60px); overflow-y: auto"
        >
          <!-- 顶部关键指标 -->
          <div
            style="
              display: grid;
              grid-template-columns: repeat(6, 1fr);
              gap: 15px;
              margin-bottom: 20px;
            "
          >
            <div class="mini-stat">
              <div class="mini-stat-number" id="total-projects">0</div>
              <div class="mini-stat-label">总项目</div>
            </div>
            <div class="mini-stat">
              <div
                class="mini-stat-number"
                id="active-projects"
                style="color: #27ae60"
              >
                0
              </div>
              <div class="mini-stat-label">进行中</div>
            </div>
            <div class="mini-stat">
              <div
                class="mini-stat-number"
                id="avg-progress"
                style="color: #3498db"
              >
                0%
              </div>
              <div class="mini-stat-label">平均进度</div>
            </div>
            <div class="mini-stat">
              <div
                class="mini-stat-number"
                id="total-budget"
                style="color: #f39c12"
              >
                0万
              </div>
              <div class="mini-stat-label">总预算</div>
            </div>
            <div class="mini-stat">
              <div
                class="mini-stat-number"
                id="team-count"
                style="color: #9b59b6"
              >
                0人
              </div>
              <div class="mini-stat-label">团队规模</div>
            </div>
            <div class="mini-stat">
              <div
                class="mini-stat-number"
                id="dcp-pass-rate"
                style="color: #e74c3c"
              >
                0%
              </div>
              <div class="mini-stat-label">DCP通过率</div>
            </div>
          </div>

          <!-- 主要图表区域 -->
          <div
            style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              grid-template-rows: repeat(2, 1fr);
              gap: 15px;
              height: calc(100% - 100px);
            "
          >
            <!-- 项目状态分布 -->
            <div class="chart-container" style="height: 100%">
              <div class="chart-title">项目状态分布</div>
              <div
                id="project-status-chart"
                class="chart-content"
                style="height: calc(100% - 30px); overflow-y: auto"
              >
                <!-- 项目状态进度条 -->
              </div>
            </div>

            <!-- 阶段分布 -->
            <div class="chart-container" style="height: 100%">
              <div class="chart-title">IPD阶段分布</div>
              <div
                id="stage-distribution-chart"
                class="chart-content"
                style="height: calc(100% - 30px); overflow-y: auto"
              >
                <!-- 阶段分布进度条 -->
              </div>
            </div>

            <!-- 项目进度一览 -->
            <div class="chart-container" style="height: 100%">
              <div class="chart-title">项目进度一览</div>
              <div
                id="project-progress-chart"
                class="chart-content"
                style="height: calc(100% - 30px); overflow-y: auto"
              >
                <!-- 项目进度进度条 -->
              </div>
            </div>

            <!-- 团队工作负载 -->
            <div class="chart-container" style="height: 100%">
              <div class="chart-title">团队负载</div>
              <div
                id="team-workload-chart"
                class="chart-content"
                style="height: calc(100% - 30px); overflow-y: auto"
              >
                <!-- 团队工作负载进度条 -->
              </div>
            </div>

            <!-- 项目预算情况 -->
            <div class="chart-container" style="height: 100%">
              <div class="chart-title">项目预算情况</div>
              <div
                id="project-budget-chart"
                class="chart-content"
                style="height: calc(100% - 30px); overflow-y: auto"
              >
                <!-- 项目预算进度条 -->
              </div>
            </div>

            <!-- 项目DCP情况 -->
            <div class="chart-container" style="height: 100%">
              <div class="chart-title">项目DCP情况</div>
              <div
                id="project-dcp-chart"
                class="chart-content"
                style="height: calc(100% - 30px); overflow-y: auto"
              >
                <!-- 项目DCP进度条 -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 引入脚本 -->
    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
      // 渲染关键指标
      function renderKeyMetrics() {
        var projects = IPD_DATA.projects;
        var users = IPD_DATA.users;
        var dcpReviews = IPD_DATA.dcpReviews;

        var totalProjects = projects.length;
        var activeProjects = projects.filter(function (p) {
          return p.status === "in_progress";
        }).length;
        var avgProgress =
          totalProjects > 0
            ? Math.round(
                projects.reduce(function (sum, p) {
                  return sum + p.progress;
                }, 0) / totalProjects
              )
            : 0;
        var totalBudget = Math.round(
          projects.reduce(function (sum, p) {
            return sum + (p.budget || 0);
          }, 0) / 10000
        );
        var teamCount = users.length;
        var completedReviews = dcpReviews.filter(function (r) {
          return r.status === "completed";
        }).length;
        var passedReviews = dcpReviews.filter(function (r) {
          return r.result === "pass";
        }).length;
        var dcpPassRate =
          completedReviews > 0
            ? Math.round((passedReviews / completedReviews) * 100)
            : 0;

        document.getElementById("total-projects").textContent = totalProjects;
        document.getElementById("active-projects").textContent = activeProjects;
        document.getElementById("avg-progress").textContent = avgProgress + "%";
        document.getElementById("total-budget").textContent =
          totalBudget + "万";
        document.getElementById("team-count").textContent = teamCount + "人";
        document.getElementById("dcp-pass-rate").textContent =
          dcpPassRate + "%";
      }

      // 渲染项目状态分布
      function renderProjectStatusChart() {
        var container = document.getElementById("project-status-chart");
        var projects = IPD_DATA.projects;

        var statusCount = {
          planning: 0,
          in_progress: 0,
          completed: 0,
        };

        projects.forEach(function (p) {
          statusCount[p.status] = (statusCount[p.status] || 0) + 1;
        });

        var colors = {
          planning: "#f39c12",
          in_progress: "#3498db",
          completed: "#27ae60",
        };

        var labels = {
          planning: "规划中",
          in_progress: "进行中",
          completed: "已完成",
        };

        var total = projects.length;
        var html = '<div class="progress-list">';

        for (var status in statusCount) {
          if (statusCount[status] > 0) {
            var percentage = Math.round((statusCount[status] / total) * 100);
            html += '<div class="progress-item">';
            html += '<div class="progress-name">' + labels[status] + "</div>";
            html += '<div class="progress-bar-mini">';
            html +=
              '<div class="progress-fill-mini" style="width: ' +
              percentage +
              "%; background: " +
              colors[status] +
              ';"></div>';
            html += "</div>";
            html +=
              '<div class="progress-value">' + statusCount[status] + "个</div>";
            html += "</div>";
          }
        }

        html += "</div>";
        container.innerHTML = html;
      }

      // 渲染阶段分布
      function renderStageDistributionChart() {
        var container = document.getElementById("stage-distribution-chart");
        var projects = IPD_DATA.projects;
        var stages = [
          "concept",
          "plan",
          "develop",
          "verify",
          "release",
          "lifecycle",
        ];

        var maxCount = 0;
        var stageCounts = {};

        stages.forEach(function (stage) {
          var count = projects.filter(function (p) {
            return p.currentStage === stage;
          }).length;
          stageCounts[stage] = count;
          maxCount = Math.max(maxCount, count);
        });

        var html = '<div class="progress-list">';

        stages.forEach(function (stage) {
          var count = stageCounts[stage];
          var percentage =
            maxCount > 0 ? Math.round((count / maxCount) * 100) : 0;

          html += '<div class="progress-item">';
          html +=
            '<div class="progress-name">' +
            getStageText(stage).replace("阶段", "") +
            "</div>";
          html += '<div class="progress-bar-mini">';
          html +=
            '<div class="progress-fill-mini" style="width: ' +
            percentage +
            '%; background: #3498db;"></div>';
          html += "</div>";
          html += '<div class="progress-value">' + count + "个</div>";
          html += "</div>";
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // 渲染项目进度图表
      function renderProjectProgressChart() {
        var container = document.getElementById("project-progress-chart");
        var projects = IPD_DATA.projects;

        var html = '<div class="progress-list">';

        projects.forEach(function (project) {
          var statusColor =
            project.status === "completed"
              ? "#27ae60"
              : project.status === "in_progress"
              ? "#3498db"
              : "#f39c12";

          html += '<div class="progress-item">';
          html +=
            '<div class="progress-name" title="' +
            project.name +
            '">' +
            (project.name.length > 8
              ? project.name.substring(0, 8) + "..."
              : project.name) +
            "</div>";
          html += '<div class="progress-bar-mini">';
          html +=
            '<div class="progress-fill-mini" style="width: ' +
            project.progress +
            "%; background: " +
            statusColor +
            ';"></div>';
          html += "</div>";
          html += '<div class="progress-value">' + project.progress + "%</div>";
          html += "</div>";
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // 渲染团队工作负载图表
      function renderTeamWorkloadChart() {
        var container = document.getElementById("team-workload-chart");
        var users = IPD_DATA.users
          .filter(function (u) {
            return u.department === "研发部";
          })
          .slice(0, 6);

        var html = '<div class="progress-list">';

        users.forEach(function (user) {
          var workloadColor =
            user.workload > 80
              ? "#e74c3c"
              : user.workload > 60
              ? "#f39c12"
              : "#27ae60";

          html += '<div class="progress-item">';
          html += '<div class="progress-name">' + user.name + "</div>";
          html += '<div class="progress-bar-mini">';
          html +=
            '<div class="progress-fill-mini" style="width: ' +
            user.workload +
            "%; background: " +
            workloadColor +
            ';"></div>';
          html += "</div>";
          html += '<div class="progress-value">' + user.workload + "%</div>";
          html += "</div>";
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // 渲染项目预算情况图表
      function renderProjectBudgetChart() {
        var container = document.getElementById("project-budget-chart");
        var projects = IPD_DATA.projects;

        var html = '<div class="progress-list">';

        projects.forEach(function (project) {
          var budget = project.budget || 0;
          var budgetInWan = Math.round(budget / 10000);
          var maxBudget = Math.max.apply(
            Math,
            projects.map(function (p) {
              return p.budget || 0;
            })
          );
          var percentage =
            maxBudget > 0 ? Math.round((budget / maxBudget) * 100) : 0;

          var budgetColor =
            budget > 500000
              ? "#e74c3c"
              : budget > 200000
              ? "#f39c12"
              : "#27ae60";

          html += '<div class="progress-item">';
          html +=
            '<div class="progress-name" title="' +
            project.name +
            '">' +
            (project.name.length > 8
              ? project.name.substring(0, 8) + "..."
              : project.name) +
            "</div>";
          html += '<div class="progress-bar-mini">';
          html +=
            '<div class="progress-fill-mini" style="width: ' +
            percentage +
            "%; background: " +
            budgetColor +
            ';"></div>';
          html += "</div>";
          html += '<div class="progress-value">' + budgetInWan + "万</div>";
          html += "</div>";
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // 渲染项目DCP情况图表
      function renderProjectDcpChart() {
        var container = document.getElementById("project-dcp-chart");
        var projects = IPD_DATA.projects;
        var dcpReviews = IPD_DATA.dcpReviews;

        var html = '<div class="progress-list">';

        projects.forEach(function (project) {
          var projectReviews = dcpReviews.filter(function (r) {
            return r.projectId === project.id;
          });
          var completedReviews = projectReviews.filter(function (r) {
            return r.status === "completed";
          });
          var passedReviews = completedReviews.filter(function (r) {
            return r.result === "pass" || r.result === "conditional_pass";
          });

          var passRate = 0;
          var displayText = "";

          if (projectReviews.length === 0) {
            // 没有DCP评审记录
            passRate = 0;
            displayText = "无评审";
          } else if (completedReviews.length === 0) {
            // 有评审但都未完成
            passRate = 0;
            displayText = "进行中";
          } else {
            // 有已完成的评审
            passRate = Math.round(
              (passedReviews.length / completedReviews.length) * 100
            );
            displayText = passRate + "%";
          }

          var dcpColor;
          if (displayText === "无评审" || displayText === "进行中") {
            dcpColor = "#95a5a6"; // 灰色表示无数据或进行中
          } else {
            dcpColor =
              passRate >= 80
                ? "#27ae60"
                : passRate >= 60
                ? "#f39c12"
                : "#e74c3c";
          }

          html += '<div class="progress-item">';
          html +=
            '<div class="progress-name" title="' +
            project.name +
            '">' +
            (project.name.length > 8
              ? project.name.substring(0, 8) + "..."
              : project.name) +
            "</div>";
          html += '<div class="progress-bar-mini">';
          html +=
            '<div class="progress-fill-mini" style="width: ' +
            (displayText === "无评审" || displayText === "进行中"
              ? 20
              : passRate) +
            "%; background: " +
            dcpColor +
            ';"></div>';
          html += "</div>";
          html += '<div class="progress-value">' + displayText + "</div>";
          html += "</div>";
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // 刷新数据
      function refreshData() {
        loadData(function () {
          renderAllCharts();
          showSuccessMessage("数据已刷新");
        });
      }

      // 时间范围过滤
      function filterByTime() {
        var timeRange = document.getElementById("timeRange").value;
        // 这里可以根据时间范围过滤数据
        showAlert("时间过滤功能开发中");
      }

      // 渲染所有图表
      function renderAllCharts() {
        safeRender(renderKeyMetrics, "total-projects");
        safeRender(renderProjectStatusChart, "project-status-chart");
        safeRender(renderStageDistributionChart, "stage-distribution-chart");
        safeRender(renderProjectProgressChart, "project-progress-chart");
        safeRender(renderTeamWorkloadChart, "team-workload-chart");
        safeRender(renderProjectBudgetChart, "project-budget-chart");
        safeRender(renderProjectDcpChart, "project-dcp-chart");
      }

      // 页面初始化
      document.addEventListener("DOMContentLoaded", function () {
        // 检查登录状态
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
          window.location.href = "login.html";
          return;
        }

        loadData(function () {
          renderAllCharts();
        });
      });
    </script>
  </body>
</html>
